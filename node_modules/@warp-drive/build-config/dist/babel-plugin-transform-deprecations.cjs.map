{"version":3,"file":"babel-plugin-transform-deprecations.cjs","sources":["../cjs-src/transforms/babel-plugin-transform-deprecations.js"],"sourcesContent":["import { ImportUtil } from 'babel-import-util';\n\nfunction parentIsUnary(node) {\n  if (node.parent.type === 'UnaryExpression' && node.parent.operator === '!') {\n    return true;\n  }\n  return false;\n}\n\nexport default function (babel) {\n  const { types: t } = babel;\n\n  return {\n    name: 'deprecation-flags',\n    visitor: {\n      ImportDeclaration(path, state) {\n        const importPath = path.node.source.value;\n\n        if (importPath === state.opts.source) {\n          const specifiers = path.get('specifiers');\n          specifiers.forEach((specifier) => {\n            let name = specifier.node.imported.name;\n            if (!(name in state.opts.flags)) {\n              throw new Error(`Unexpected flag ${name} imported from ${state.opts.source}`);\n            }\n            let localBindingName = specifier.node.local.name;\n            let binding = specifier.scope.getBinding(localBindingName);\n            binding.referencePaths.forEach((p, other) => {\n              let negateStatement = false;\n              let node = p;\n              if (parentIsUnary(p)) {\n                negateStatement = true;\n                node = p.parentPath;\n              }\n              let getConfig = t.memberExpression(\n                t.memberExpression(\n                  t.memberExpression(\n                    t.callExpression(state.importer.import(p, '@embroider/macros', 'getGlobalConfig'), []),\n                    t.identifier('WarpDrive')\n                  ),\n                  t.identifier('deprecations')\n                ),\n                t.identifier(name)\n              );\n              node.replaceWith(\n                // if (DEPRECATE_FOO)\n                // =>\n                // if (macroCondition(getGlobalConfig('WarpDrive').debug.LOG_FOO))\n                t.callExpression(state.importer.import(p, '@embroider/macros', 'macroCondition'), [\n                  negateStatement ? t.unaryExpression('!', getConfig) : getConfig,\n                ])\n              );\n            });\n            specifier.scope.removeOwnBinding(localBindingName);\n            specifier.remove();\n          });\n          if (path.get('specifiers').length === 0) {\n            path.remove();\n          }\n        }\n      },\n\n      Program(path, state) {\n        state.importer = new ImportUtil(t, path);\n      },\n    },\n  };\n}\n"],"names":["parentIsUnary","node","parent","type","operator","babel","types","t","name","visitor","ImportDeclaration","path","state","importPath","source","value","opts","specifiers","get","forEach","specifier","imported","flags","Error","localBindingName","local","binding","scope","getBinding","referencePaths","p","other","negateStatement","parentPath","getConfig","memberExpression","callExpression","importer","import","identifier","replaceWith","unaryExpression","removeOwnBinding","remove","length","Program","ImportUtil"],"mappings":";;;;AAEA,SAASA,aAAaA,CAACC,IAAI,EAAE;AAC3B,EAAA,IAAIA,IAAI,CAACC,MAAM,CAACC,IAAI,KAAK,iBAAiB,IAAIF,IAAI,CAACC,MAAM,CAACE,QAAQ,KAAK,GAAG,EAAE;AAC1E,IAAA,OAAO,IAAI,CAAA;AACb,GAAA;AACA,EAAA,OAAO,KAAK,CAAA;AACd,CAAA;AAEe,yCAAA,EAAUC,KAAK,EAAE;EAC9B,MAAM;AAAEC,IAAAA,KAAK,EAAEC,CAAAA;AAAE,GAAC,GAAGF,KAAK,CAAA;EAE1B,OAAO;AACLG,IAAAA,IAAI,EAAE,mBAAmB;AACzBC,IAAAA,OAAO,EAAE;AACPC,MAAAA,iBAAiBA,CAACC,IAAI,EAAEC,KAAK,EAAE;QAC7B,MAAMC,UAAU,GAAGF,IAAI,CAACV,IAAI,CAACa,MAAM,CAACC,KAAK,CAAA;AAEzC,QAAA,IAAIF,UAAU,KAAKD,KAAK,CAACI,IAAI,CAACF,MAAM,EAAE;AACpC,UAAA,MAAMG,UAAU,GAAGN,IAAI,CAACO,GAAG,CAAC,YAAY,CAAC,CAAA;AACzCD,UAAAA,UAAU,CAACE,OAAO,CAAEC,SAAS,IAAK;YAChC,IAAIZ,IAAI,GAAGY,SAAS,CAACnB,IAAI,CAACoB,QAAQ,CAACb,IAAI,CAAA;YACvC,IAAI,EAAEA,IAAI,IAAII,KAAK,CAACI,IAAI,CAACM,KAAK,CAAC,EAAE;AAC/B,cAAA,MAAM,IAAIC,KAAK,CAAE,CAAA,gBAAA,EAAkBf,IAAK,CAAA,eAAA,EAAiBI,KAAK,CAACI,IAAI,CAACF,MAAO,CAAA,CAAC,CAAC,CAAA;AAC/E,aAAA;YACA,IAAIU,gBAAgB,GAAGJ,SAAS,CAACnB,IAAI,CAACwB,KAAK,CAACjB,IAAI,CAAA;YAChD,IAAIkB,OAAO,GAAGN,SAAS,CAACO,KAAK,CAACC,UAAU,CAACJ,gBAAgB,CAAC,CAAA;YAC1DE,OAAO,CAACG,cAAc,CAACV,OAAO,CAAC,CAACW,CAAC,EAAEC,KAAK,KAAK;cAC3C,IAAIC,eAAe,GAAG,KAAK,CAAA;cAC3B,IAAI/B,IAAI,GAAG6B,CAAC,CAAA;AACZ,cAAA,IAAI9B,aAAa,CAAC8B,CAAC,CAAC,EAAE;AACpBE,gBAAAA,eAAe,GAAG,IAAI,CAAA;gBACtB/B,IAAI,GAAG6B,CAAC,CAACG,UAAU,CAAA;AACrB,eAAA;cACA,IAAIC,SAAS,GAAG3B,CAAC,CAAC4B,gBAAgB,CAChC5B,CAAC,CAAC4B,gBAAgB,CAChB5B,CAAC,CAAC4B,gBAAgB,CAChB5B,CAAC,CAAC6B,cAAc,CAACxB,KAAK,CAACyB,QAAQ,CAACC,MAAM,CAACR,CAAC,EAAE,mBAAmB,EAAE,iBAAiB,CAAC,EAAE,EAAE,CAAC,EACtFvB,CAAC,CAACgC,UAAU,CAAC,WAAW,CAC1B,CAAC,EACDhC,CAAC,CAACgC,UAAU,CAAC,cAAc,CAC7B,CAAC,EACDhC,CAAC,CAACgC,UAAU,CAAC/B,IAAI,CACnB,CAAC,CAAA;AACDP,cAAAA,IAAI,CAACuC,WAAW;AACd;AACA;AACA;AACAjC,cAAAA,CAAC,CAAC6B,cAAc,CAACxB,KAAK,CAACyB,QAAQ,CAACC,MAAM,CAACR,CAAC,EAAE,mBAAmB,EAAE,gBAAgB,CAAC,EAAE,CAChFE,eAAe,GAAGzB,CAAC,CAACkC,eAAe,CAAC,GAAG,EAAEP,SAAS,CAAC,GAAGA,SAAS,CAChE,CACH,CAAC,CAAA;AACH,aAAC,CAAC,CAAA;AACFd,YAAAA,SAAS,CAACO,KAAK,CAACe,gBAAgB,CAAClB,gBAAgB,CAAC,CAAA;YAClDJ,SAAS,CAACuB,MAAM,EAAE,CAAA;AACpB,WAAC,CAAC,CAAA;UACF,IAAIhC,IAAI,CAACO,GAAG,CAAC,YAAY,CAAC,CAAC0B,MAAM,KAAK,CAAC,EAAE;YACvCjC,IAAI,CAACgC,MAAM,EAAE,CAAA;AACf,WAAA;AACF,SAAA;OACD;AAEDE,MAAAA,OAAOA,CAAClC,IAAI,EAAEC,KAAK,EAAE;QACnBA,KAAK,CAACyB,QAAQ,GAAG,IAAIS,0BAAU,CAACvC,CAAC,EAAEI,IAAI,CAAC,CAAA;AAC1C,OAAA;AACF,KAAA;GACD,CAAA;AACH;;;;"}